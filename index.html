<!DOCTYPE html>
<html lang="de">
<head>

<link rel="apple-touch-icon" sizes="512x512" href="icon.png">
<link rel="apple-touch-icon" sizes="192x192" href="icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180.png">
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

  <meta charset="UTF-8">
  <title>Turnier-App EHC Biel-Bienne</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --blau: #2775e3;
      --rot: #df4848;
      --gelb: #ffd600;
      --schwarz: #222;
      --primary: #df4848;
      --secondary: #0033a0;
      --bg: #f0f4fb;
      --card: #fff;
      --border: #e0e0e0;
      --radius: 18px;
      --shadow: 0 8px 24px #0033a018;
      --ice: #e9f2ff;
      --line: #c0d9ff;
      --font: 'Avenir', 'Segoe UI', Arial, sans-serif;
      --cardwidth: 670px;
    }
    html, body {
      font-family: var(--font);
      background: var(--bg);
      color: #1a1a1a;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2.2rem 0 2rem 0;
      background:
        radial-gradient(circle at 6% 5%, #ffffff 0, #ffffff00 30%),
        radial-gradient(circle at 94% 92%, #dfe8fa 0, #dfe8fa00 35%),
        linear-gradient(140deg, #f7faff 0%, #eef4ff 60%, #ecf2fd 100%),
        var(--bg);
    }
    .logo {
      width: 110px;
      margin-bottom: 1.1rem;
      border-radius: 50%;
      box-shadow: var(--shadow);
      background: #fff;
      padding: 13px;
      border: 3px solid #e8e8e8;
      display: block;
    }
    h1 {
      color: var(--primary);
      font-weight: 600;
      font-size: 2.35rem;
      text-align: center;
      letter-spacing: 0.01em;
      margin: 0 0 1.3rem 0;
    }
    h2 {
      color: var(--secondary);
      margin: 1.0rem 0 0.5rem 0;
      font-weight: 500;
      text-align: center;
      font-size: 1.17em;
      letter-spacing: 0.01em;
    }
    .card {
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 1.2rem 2.2rem;
      width: 100%;
      max-width: var(--cardwidth);
      margin: 0.7rem auto 1.2rem;
      border: 1.1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    .card::after {
      content: "";
      position: absolute;
      left: -20%;
      top: 0;
      width: 140%;
      height: 4px;
      background: linear-gradient(90deg, var(--secondary), var(--primary));
      opacity: 0.12;
    }
    .view-row {
      display: flex;
      justify-content: center;
      margin: 0.5em 0 0.2em 0;
      gap: 0.6rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .view-label {
      background: #e8eef9;
      color: #234679;
      border: 1px solid #d4dff0;
      border-radius: 9px;
      padding: 0.35em 0.8em;
      font-size: 0.96em;
      font-weight: 600;
    }
    .view-select {
      border: 1.2px solid #c9d3e3;
      border-radius: 9px;
      background: #fff;
      color: #1f2e45;
      font-size: 1em;
      padding: 0.42em 0.85em;
      min-width: 190px;
      box-shadow: 0 2px 7px #0033a012;
    }
    .runde-block {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.0rem 2rem 1.1rem 2rem;
      max-width: var(--cardwidth);
      width: 100%;
      margin: 1.1rem auto 1.1rem auto;
      border: 1.1px solid var(--border);
    }
    .runde-title {
      font-size: 1.13em;
      font-weight: 600;
      color: var(--secondary);
      margin-bottom: 0.7rem;
      letter-spacing: 0.02em;
    }
    .tabelle-card {
      background: var(--card);
      border-radius: 14px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: var(--cardwidth);
      margin: 1.1rem auto 1.3rem auto;
      border: 1.1px solid var(--border);
      padding: 1.1rem 0 1.2rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .tab-headline {
      color: var(--secondary);
      font-size: 1.19em;
      font-weight: 500;
      text-align: center;
      margin-bottom: 0.7em;
      letter-spacing: 0.01em;
    }
    table.tabelle {
      width: 98%;
      border-collapse: collapse;
      font-size: 1.07em;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      font-family: var(--font);
      margin: 0 auto;
    }
    .tabelle th, .tabelle td {
      border: 1.1px solid #e0e0e0;
      padding: 11px 7px;
      text-align: center;
      font-family: var(--font);
      font-weight: 400;
    }
    .tabelle th {
      background: var(--secondary);
      color: #fff;
      font-weight: 400;
      font-size: 1.11em;
      letter-spacing: 0.012em;
      border-bottom: 2.1px solid #0033a0;
    }
    .tabelle tr td:first-child { font-weight: 400; }
    .tabelle .team-badge { min-width: 54px; display:inline-block; font-size: 1.08em;}
    .games-row, .pairing-row {
      width: 100%;
    }
    .game-badge, .pairing-row {
      display: flex;
      align-items: center;
      background: linear-gradient(180deg, #fbfdff 0%, #f3f8ff 100%);
      border-radius: 14px;
      border: 1px solid #d8e4f7;
      padding: 0.35em 1.5em;
      margin-bottom: 0.6em;
      gap: 1.2rem;
      width: 100%;
      font-size: 1.13em;
      box-sizing: border-box;
    }
    .score-box {
      display: flex;
      align-items: center;
      gap: 0.32em;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #c8d5ea;
      font-size: 1.13em;
      padding: 5px 13px;
      margin-left: auto;
      min-width: 75px;
      box-sizing: border-box;
    }
    .score-input {
      width: 2.8ch;
      padding: 6px 2px;
      margin: 0 1px;
      border: 1px solid #bbb;
      border-radius: 5px;
      font-size: 1.13em;
      font-family: var(--font);
      font-weight: 400;
      text-align: center;
      background: #fff !important;
      color: #1a1a1a !important;
      outline: none;
      transition: border 0.18s, box-shadow 0.15s;
      letter-spacing: 0.01em;
      box-shadow: 0 1px 2px #0034a006;
      appearance: textfield;
    }
    .game-pending .score-box {
      border-color: #f0b13c;
      background: #fff9ee;
    }
    .score-input:focus { border: 1px solid var(--secondary); background: #f4faff; }
    .score-box span.sep {
      font-size: 1.11em;
      color: #222;
      font-family: var(--font);
      font-weight: 400;
      margin: 0 2px;
      user-select: none;
    }
    
#teams {
  display: flex;
  flex-direction: row;
  gap: 1.1rem;
  width: 100%;
  max-width: 800px;
  justify-content: center;
  overflow-x: auto;
  padding-bottom: 0.3rem;
  flex-wrap: wrap;
}

.team-edit-badge {
  display: flex;
  align-items: center;
  background: #ededed;
  border-radius: 11px;
  border: 1px solid #d4d4d4;
  padding: 0.24em 0.8em 0.24em 1em;
  min-width: 80px;
  font-size: 1.19em;
  font-weight: 400;
  gap: 0.3em;
  margin-bottom: 0.1em;
  cursor: pointer;
  transition: background 0.13s;
  flex: 0 1 auto;
  white-space: normal;
}

.team-edit-badge input[type="text"] {
  border: none;
  background: transparent;
  font-size: 1.19em;
  font-weight: 500;
  color: inherit;
  width: auto;
  flex: 1 1 auto;
  overflow: visible;
  text-overflow: unset;
  text-align: center;
  outline: none;
  padding: 0 0.5em;
  border-radius: 6px;
  letter-spacing: 0.03em;
  font-family: var(--font);
}

.team-edit-badge input[type="text"]:focus {
  background: #fff6;
}



    .colorpicker-icon {
      width: 19px;
      height: 19px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 0.2em;
      border-radius: 6px;
      background: #fff;
      border: 1px solid #ddd;
      box-shadow: 0 1px 4px #0001;
      cursor: pointer;
      position: relative;
    }
    .colorpicker-icon svg { width: 13px; height: 13px; display: block; }
    .team-edit-badge input[type="color"] {
      position: absolute;
      right: 2px;
      top: 50%;
      transform: translateY(-50%);
      width: 19px;
      height: 19px;
      opacity: 0;
      cursor: pointer;
    }
    .field-label {
      font-weight: 400;
      background: #e8e8e8;
      border-radius: 9px;
      padding: 6px 20px;
      margin: 0 12px 0 0;
      min-width: 66px;
      text-align: center;
      border: 1.1px solid #e0e0e0;
      font-size: 1.08em;
      letter-spacing: 0.03em;
    }
    .team-badge {
      display: inline-block;
      border-radius: 10px;
      padding: 6px 18px 6px 14px;
      font-weight: 500;
      font-size: 1.15em;
      color: #fff;
      margin: 0 2px;
      background: #ededed;
      border: 1px solid #d4d4d4;
      min-width: 54px;
      text-align: center;
      letter-spacing: 0.02em;
    }
    .team-blau { background: var(--blau) !important; color: #fff !important;}
    .team-rot { background: var(--rot) !important; color: #fff !important;}
    .team-gelb { background: var(--gelb) !important; color: #222 !important;}
    .team-schwarz { background: var(--schwarz) !important; color: #fff !important;}

    .modus-row {
      justify-content: center;
      display: flex;
      margin: 0.7em 0 1.1em 0;
    }
    .modus-big {
      font-size: 1.25em;
      font-weight: 500;
      border-radius: 11px;
      border: 1.2px solid #c9d3e3;
      background: #fff;
      color: #111;
      min-width: 250px;
      height: 42px;
      box-shadow: 0 2px 7px #0033a012;
      padding: 0.3em 1.2em 0.3em 1.2em;
      outline: none;
      margin: 0;
      display: block;
      transition: border 0.17s, box-shadow 0.13s;
    }
    .modus-big:focus {
      border: 1.2px solid var(--secondary);
      box-shadow: 0 4px 13px #0033a032;
    }
    .timer-section {
      background: linear-gradient(90deg, #fff7ea 0%, #fff0dd 100%);
      border-radius: 13px;
      padding: 14px 32px;
      margin: 30px auto 27px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 18px;
      max-width: 760px;
      width: min(95vw, 760px);
      font-size: 1.21em;
      box-shadow: 0 6px 20px #d462131f;
      position: sticky;
      top: 10px;
      z-index: 20;
      border: 1px solid #ffd6b1;
    }
    .timer-section label {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 1.17em;
    }
    .timer-section input[type="number"] {
      width: 2.3em;
      font-size: 1.17em;
      text-align: center;
      border: 1.2px solid #ccc;
      border-radius: 8px;
      padding: 5px 7px;
      margin: 0 1px;
      font-family: inherit;
      font-weight: 500;
      background: #fff;
      outline: none;
      transition: border 0.18s;
    }
    .timer-section button {
      font-size: 1.18em;
      background: linear-gradient(90deg, #c00 80%, #f57c00 100%);
      color: #fff;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      padding: 0.23em 1.2em;
      height: 2.1em;
      min-width: 81px;
      margin-left: 0.8em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(200,0,0,0.07);
      outline: none;
      transition: filter 0.1s;
    }
    .timer-section button:active { filter: brightness(0.96);}
    .timer-countdown {
      color: var(--primary);
      font-size: 1.22em;
      font-weight: 700;
      margin-left: 12px;
      min-width: 60px;
      letter-spacing: 1.1px;
      font-family: var(--font);
    }
    .progress-chip {
      background: #ffffffcc;
      border: 1px solid #ffd0ac;
      color: #7d3f11;
      border-radius: 999px;
      padding: 0.35em 0.85em;
      font-weight: 600;
      font-size: 0.84em;
      letter-spacing: 0.01em;
      min-width: 140px;
      text-align: center;
    }
    body.view-broadcast {
      --cardwidth: 1120px;
      --shadow: 0 12px 28px #001e4a20;
      padding-top: 1.2rem;
    }
    body.view-broadcast h1 {
      font-size: clamp(2.2rem, 3.8vw, 3.5rem);
      margin-bottom: 0.7rem;
    }
    body.view-broadcast .logo {
      width: 140px;
      margin-bottom: 0.6rem;
    }
    body.view-broadcast .card,
    body.view-broadcast .runde-block,
    body.view-broadcast .tabelle-card {
      max-width: min(96vw, 1200px);
    }
    body.view-broadcast .game-badge,
    body.view-broadcast .pairing-row {
      font-size: 1.38em;
      padding: 0.55em 1.2em;
      border-radius: 16px;
    }
    body.view-broadcast .score-input {
      width: 3.2ch;
      font-size: 1.3em;
      padding: 9px 4px;
    }
    body.view-broadcast .team-badge {
      font-size: 1.2em;
      padding: 8px 18px 8px 15px;
    }
    body.view-broadcast .field-label {
      font-size: 1.02em;
      min-width: 84px;
    }
    body.view-broadcast .timer-section {
      max-width: min(96vw, 1200px);
      width: min(96vw, 1200px);
      top: 6px;
      padding: 16px 20px;
    }
    body.view-broadcast .timer-countdown {
      font-size: 1.6em;
      letter-spacing: 0.06em;
    }
    body.view-iphone {
      padding: 0.4rem 0 1rem 0;
      background:
        linear-gradient(180deg, #f6f9ff 0%, #eef4ff 100%),
        var(--bg);
    }
    body.view-iphone .logo {
      width: 66px;
      margin-bottom: 0.55rem;
      padding: 8px;
    }
    body.view-iphone h1 {
      font-size: 1.35rem;
      margin-bottom: 0.8rem;
    }
    body.view-iphone .card,
    body.view-iphone .runde-block,
    body.view-iphone .tabelle-card {
      width: min(100vw - 12px, 540px);
      max-width: min(100vw - 12px, 540px);
      border-radius: 14px;
      margin: 0.4rem auto;
      padding: 0.8rem 0.72rem;
    }
    body.view-iphone .tabelle-card {
      padding: 0.8rem 0.2rem 1rem;
    }
    body.view-iphone .modus-big,
    body.view-iphone .view-select {
      min-width: 0;
      width: 100%;
      font-size: 1.03em;
      height: 44px;
    }
    body.view-iphone #teams {
      gap: 0.45rem;
      justify-content: stretch;
    }
    body.view-iphone .team-edit-badge {
      width: calc(50% - 0.3rem);
      min-width: 0;
      font-size: 1em;
      padding: 0.3em 0.5em;
      box-sizing: border-box;
    }
    body.view-iphone .team-edit-badge .colorpicker-icon {
      display: none;
    }
    body.view-iphone .team-edit-badge input[type="color"] {
      position: static;
      transform: none;
      opacity: 1;
      width: 28px;
      height: 28px;
      margin-left: 4px;
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
    }
    body.view-iphone .game-badge,
    body.view-iphone .pairing-row {
      padding: 0.5rem 0.5rem;
      gap: 0.42rem;
      font-size: 0.91em;
      border-radius: 11px;
    }
    body.view-iphone .field-label {
      min-width: 44px;
      margin-right: 3px;
      padding: 4px 6px;
      font-size: 0.85em;
    }
    body.view-iphone .team-badge {
      min-width: 34px;
      padding: 4px 8px;
      font-size: 0.92em;
      margin: 0;
    }
    body.view-iphone .score-box {
      min-width: 82px;
      padding: 4px 7px;
      gap: 0.25em;
    }
    body.view-iphone .score-input {
      width: 2.6ch;
      font-size: 1.02em;
      padding: 8px 2px;
    }
    body.view-iphone .timer-section {
      top: 0;
      width: 100vw;
      border-radius: 0;
      margin: 6px 0 8px 0;
      padding: 8px 8px;
      gap: 8px;
      z-index: 30;
    }
    body.view-iphone .timer-section label {
      font-size: 0.94em;
    }
    body.view-iphone .timer-section input[type="number"] {
      width: 2.8em;
      font-size: 1.05em;
    }
    body.view-iphone .timer-section button {
      margin-left: 0;
      min-width: 72px;
      height: 2em;
      font-size: 1em;
    }
    body.view-iphone .timer-countdown {
      font-size: 1.07em;
      margin-left: 0;
      min-width: 58px;
    }
    body.view-iphone .progress-chip {
      min-width: 110px;
      font-size: 0.76em;
      padding: 0.26em 0.58em;
    }
    @media (max-width: 800px) {
      .card, .runde-block, .tabelle-card { max-width: 99vw; }
    }
    @media (max-width: 600px) {
      .game-badge, .pairing-row { font-size: 0.97em; gap: 0.5rem; padding: 0.45rem 0.65rem;}
      .score-box { padding: 4px 6px; min-width: 48px;}
      .team-badge { font-size: 1em; min-width: 38px; }
      .field-label { padding: 4px 8px; min-width: 32px;}
      .logo { width: 75px; }
      .score-input { width: 3.1ch; font-size: 1.05em; padding: 7px 2px; }
      .timer-section { top: 0; border-radius: 0; width: 100vw; padding: 10px 10px; margin: 12px 0; }
      .timer-countdown { margin-left: 0; }
    }
  </style>
</head>
<body>
<img src="ehcb-logo.png" class="logo" alt="EHCB Logo">
<h1>Turnier-App EHC Biel-Bienne</h1>
<div class="card">
  <h2>Teams & Farben</h2>
  <div id="teams"></div>
</div>
<div class="card">
  <h2>Turnier-Modus</h2>
  <div class="view-row">
    <span class="view-label">Ansicht</span>
    <select id="viewMode" class="view-select">
      <option value="auto">Auto (Gerät)</option>
      <option value="standard">Standard</option>
      <option value="broadcast">Broadcast (iPad/TV)</option>
      <option value="iphone">iPhone (Touch)</option>
    </select>
  </div>
  <div class="modus-row">
    <select id="mode" class="modus-big">
      <option value="jgj">Jeder gegen Jeden</option>
      <option value="hrr">Hin-&-Rückrunde</option>
      <option value="direct">Vorrunde + Direkter Final</option>
      <option value="playoff">Playoff (Vorrunde+HF+Platz 3+Finale)</option>
      <option value="gol">Grossfeld – 3 Spiele pro Team</option>
    </select>
  </div>
</div>
<div class="card">
  <h2>Spielplan</h2>
  <div id="match-editor"></div>
</div>
<div class="timer-section" style="margin-bottom:1.3rem;">
  <label>
    <input id="min" type="number" min="0" max="59" value="5" /> Min
  </label>
  <label>
    <input id="sec" type="number" min="0" max="59" value="0" /> Sek
  </label>
  <button id="startBtn">Start</button>
  <span class="timer-countdown" id="countdown">05:00</span>
  <span class="progress-chip" id="match-progress">Erfasst: 0/0</span>
</div>
<div id="runde-list"></div>
<div class="tabelle-card">
  <div class="tab-headline">Gesamt-Tabelle</div>
  <table class="tabelle" id="tabelle">
    <thead>
      <tr>
        <th>Team</th>
        <th>S</th>
        <th>U</th>
        <th>N</th>
        <th>Pkte</th>
        <th>GD</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<button id="resetBtn" style="margin: 25px auto 10px auto;display:block;font-size:1.13em;background:#eee;color:#222;border-radius:9px;padding:0.7em 2em;border:1.2px solid #bbb;cursor:pointer;">Turnier zurücksetzen</button>

<audio id="buzzer" preload="auto">
  <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b4848.mp3" type="audio/mpeg">
</audio>
<audio id="horn" preload="auto">
  <source src="https://cdn.pixabay.com/audio/2022/09/27/audio_1237f0c9e2.mp3" type="audio/mpeg">
</audio>
<script>
const TEAM_COUNT = 4;

let teams = ['Blau', 'Rot', 'Gelb', 'Schwarz'];
let colors = ['#2775e3', '#df4848', '#ffd600', '#222222'];
let groupScores = [];
let resolvedMatches = [];
const VIEW_STORAGE_KEY = 'turnier.viewMode';
let currentViewMode = 'auto';

function isIPhoneLikeDevice() {
  const ua = navigator.userAgent || '';
  const isIPhoneUA = /iPhone|iPod/i.test(ua);
  const touchSmall = window.matchMedia('(pointer: coarse)').matches && window.innerWidth <= 430;
  return isIPhoneUA || touchSmall;
}

function resolveViewMode(mode) {
  if (mode === 'auto') return isIPhoneLikeDevice() ? 'iphone' : 'standard';
  return mode;
}

function applyViewMode(mode) {
  const body = document.body;
  const resolved = resolveViewMode(mode);
  body.classList.remove('view-standard', 'view-broadcast', 'view-iphone');
  body.classList.add(`view-${resolved}`);
}

function loadViewMode() {
  const saved = localStorage.getItem(VIEW_STORAGE_KEY);
  const allowed = ['auto', 'standard', 'broadcast', 'iphone'];
  currentViewMode = allowed.includes(saved) ? saved : 'auto';
  const select = document.getElementById('viewMode');
  if (select) select.value = currentViewMode;
  applyViewMode(currentViewMode);
}

function getContrastYIQ(hexcolor) {
  let normalized = (hexcolor || '#222222').replace('#', '');
  if (normalized.length === 3) normalized = normalized.split('').map((c) => c + c).join('');
  const r = parseInt(normalized.substr(0, 2), 16);
  const g = parseInt(normalized.substr(2, 2), 16);
  const b = parseInt(normalized.substr(4, 2), 16);
  const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
  return yiq >= 170 ? '#222' : '#fff';
}

function sanitizeScoreInput(value) {
  const cleaned = String(value ?? '').replace(/\D/g, '').slice(0, 2);
  return cleaned === '' ? null : Number(cleaned);
}

function normalizeScoresLength(length, preserve = true) {
  const old = groupScores.slice();
  groupScores = Array.from({ length }, (_, i) => {
    if (!preserve || !old[i]) return [null, null];
    return [sanitizeScoreInput(old[i][0]), sanitizeScoreInput(old[i][1])];
  });
}

function createRoundRobinPairs(teamCount) {
  const ids = Array.from({ length: teamCount }, (_, i) => i);
  const rounds = [];
  for (let r = 0; r < teamCount - 1; r++) {
    const pairs = [];
    for (let i = 0; i < teamCount / 2; i++) {
      const a = ids[i];
      const b = ids[teamCount - 1 - i];
      pairs.push({ a, b });
    }
    rounds.push(pairs);
    ids.splice(1, 0, ids.pop());
  }
  return rounds;
}

function flattenRounds(rounds, phase, startRound = 1) {
  const matches = [];
  let seq = 0;
  rounds.forEach((r, ridx) => {
    r.forEach((m) => {
      seq += 1;
      matches.push({
        id: `${phase}-${seq}`,
        type: 'fixed',
        phase,
        round: startRound + ridx,
        a: m.a,
        b: m.b
      });
    });
  });
  return matches;
}

function buildSchedule(mode) {
  const rrRounds = createRoundRobinPairs(TEAM_COUNT);
  const vorrunde = flattenRounds(rrRounds, 'Vorrunde', 1);
  if (mode === 'jgj' || mode === 'gol') return vorrunde;

  if (mode === 'hrr') {
    const rueckrundeRounds = rrRounds.map((round) => round.map((m) => ({ a: m.b, b: m.a })));
    const rueckrunde = flattenRounds(rueckrundeRounds, 'Rückrunde', rrRounds.length + 1);
    return [...vorrunde, ...rueckrunde];
  }

  if (mode === 'direct') {
    const finalRound = rrRounds.length + 1;
    return [
      ...vorrunde,
      { id: 'direct-final', type: 'seeded', phase: 'Finale', round: finalRound, seedA: 1, seedB: 2, tieBreak: 'seed' }
    ];
  }

  if (mode === 'playoff') {
    const semiRound = rrRounds.length + 1;
    const finalRound = rrRounds.length + 2;
    return [
      ...vorrunde,
      { id: 'hf-1', type: 'seeded', phase: 'Halbfinale', round: semiRound, seedA: 1, seedB: 4, tieBreak: 'seed' },
      { id: 'hf-2', type: 'seeded', phase: 'Halbfinale', round: semiRound, seedA: 2, seedB: 3, tieBreak: 'seed' },
      {
        id: 'p3',
        type: 'fromMatch',
        phase: 'Platz 3',
        round: finalRound,
        sourceA: { matchId: 'hf-1', result: 'loser' },
        sourceB: { matchId: 'hf-2', result: 'loser' }
      },
      {
        id: 'final',
        type: 'fromMatch',
        phase: 'Finale',
        round: finalRound,
        sourceA: { matchId: 'hf-1', result: 'winner' },
        sourceB: { matchId: 'hf-2', result: 'winner' }
      }
    ];
  }

  return vorrunde;
}

function createEmptyStats() {
  return Array.from({ length: TEAM_COUNT }, () => ({ pts: 0, gf: 0, ga: 0, win: 0, draw: 0, loss: 0 }));
}

function isCompleteScore(score) {
  return score && Number.isInteger(score[0]) && Number.isInteger(score[1]);
}

function applyMatchToStats(stats, a, b, g1, g2) {
  stats[a].gf += g1;
  stats[a].ga += g2;
  stats[b].gf += g2;
  stats[b].ga += g1;
  if (g1 > g2) {
    stats[a].pts += 3; stats[a].win += 1; stats[b].loss += 1;
  } else if (g2 > g1) {
    stats[b].pts += 3; stats[b].win += 1; stats[a].loss += 1;
  } else {
    stats[a].pts += 1; stats[b].pts += 1; stats[a].draw += 1; stats[b].draw += 1;
  }
}

function sortTeamsByStats(stats) {
  return Array.from({ length: TEAM_COUNT }, (_, teamId) => teamId).sort((a, b) =>
    stats[b].pts - stats[a].pts ||
    ((stats[b].gf - stats[b].ga) - (stats[a].gf - stats[a].ga)) ||
    (stats[b].gf - stats[a].gf) ||
    (a - b)
  );
}

function computeVorrundeRanking(schedule) {
  const stats = createEmptyStats();
  schedule.forEach((match, idx) => {
    if (match.phase !== 'Vorrunde' || match.a == null || match.b == null) return;
    const score = groupScores[idx];
    if (!isCompleteScore(score)) return;
    applyMatchToStats(stats, match.a, match.b, score[0], score[1]);
  });
  return sortTeamsByStats(stats);
}

function determineOutcome(match, idx, rankingPos) {
  const score = groupScores[idx];
  if (!isCompleteScore(score) || match.a == null || match.b == null) return null;
  if (score[0] > score[1]) return { winner: match.a, loser: match.b };
  if (score[1] > score[0]) return { winner: match.b, loser: match.a };
  if (match.tieBreak === 'seed') {
    const posA = rankingPos[match.a];
    const posB = rankingPos[match.b];
    const winner = posA <= posB ? match.a : match.b;
    const loser = winner === match.a ? match.b : match.a;
    return { winner, loser };
  }
  return null;
}

function resolveSchedule(schedule) {
  const ranking = computeVorrundeRanking(schedule);
  const rankingPos = {};
  ranking.forEach((teamId, i) => { rankingPos[teamId] = i; });
  const outcomeById = {};
  const resolved = schedule.map((match, idx) => {
    let a = null;
    let b = null;
    if (match.type === 'fixed') {
      a = match.a;
      b = match.b;
    } else if (match.type === 'seeded') {
      a = ranking[match.seedA - 1] ?? null;
      b = ranking[match.seedB - 1] ?? null;
    } else if (match.type === 'fromMatch') {
      const sourceA = outcomeById[match.sourceA.matchId];
      const sourceB = outcomeById[match.sourceB.matchId];
      a = sourceA ? sourceA[match.sourceA.result] : null;
      b = sourceB ? sourceB[match.sourceB.result] : null;
    }
    const resolvedMatch = { ...match, a, b };
    const outcome = determineOutcome(resolvedMatch, idx, rankingPos);
    if (outcome) outcomeById[match.id] = outcome;
    return resolvedMatch;
  });
  return resolved;
}

function teamBadge(teamId, fallbackText = '?') {
  if (teamId == null) return `<span class="team-badge" style="background:#d9dde4;color:#4c5566">${fallbackText}</span>`;
  const color = colors[teamId];
  const name = teams[teamId] || `Team ${teamId + 1}`;
  return `<span class="team-badge" style="background:${color};color:${getContrastYIQ(color)}">${name}</span>`;
}

function renderMatchEditor() {
  const ed = document.getElementById('match-editor');
  ed.innerHTML = '';
  const grouped = {};
  resolvedMatches.forEach((m) => {
    const key = `${m.round}-${m.phase}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(m);
  });
  Object.keys(grouped).sort((a, b) => Number(a.split('-')[0]) - Number(b.split('-')[0])).forEach((key) => {
    const matches = grouped[key];
    matches.forEach((m, fieldIdx) => {
      const row = document.createElement('div');
      row.className = 'pairing-row';
      row.innerHTML = `<span class="field-label">Feld ${fieldIdx + 1}</span> ${teamBadge(m.a, 'TBD')} vs ${teamBadge(m.b, 'TBD')} <span style="margin-left:auto;color:#5c6474;font-size:0.9em;">${m.phase}</span>`;
      ed.appendChild(row);
    });
  });
}

function renderRunden() {
  const rundeList = document.getElementById('runde-list');
  rundeList.innerHTML = '';
  const rounds = [...new Set(resolvedMatches.map((m) => m.round))].sort((a, b) => a - b);
  rounds.forEach((roundNumber) => {
    const roundMatches = resolvedMatches.filter((m) => m.round === roundNumber);
    const block = document.createElement('div');
    block.className = 'runde-block';
    block.innerHTML = `<div class="runde-title">Runde ${roundNumber} · ${roundMatches[0].phase}</div>`;
    const gamesRow = document.createElement('div');
    gamesRow.className = 'games-row';
    roundMatches.forEach((match, fieldIdx) => {
      const score = groupScores[resolvedMatches.indexOf(match)] || [null, null];
      const idx = resolvedMatches.indexOf(match);
      const pending = !isCompleteScore(score);
      const scoreDisabled = match.a == null || match.b == null ? 'disabled' : '';
      const gDiv = document.createElement('div');
      gDiv.className = pending ? 'game-badge game-pending' : 'game-badge';
      gDiv.innerHTML = `<span class="field-label">Feld ${fieldIdx + 1}</span>
        ${teamBadge(match.a, 'TBD')} vs ${teamBadge(match.b, 'TBD')}
        <span class="score-box">
          <input class="score-input" data-idx="${idx}" data-i="0" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2" value="${score[0] ?? ''}" ${scoreDisabled}>
          <span class="sep">:</span>
          <input class="score-input" data-idx="${idx}" data-i="1" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2" value="${score[1] ?? ''}" ${scoreDisabled}>
        </span>`;
      gDiv.querySelectorAll('input').forEach((input) => {
        input.addEventListener('input', (e) => {
          const target = e.target;
          const matchIdx = Number(target.dataset.idx);
          const side = Number(target.dataset.i);
          const value = sanitizeScoreInput(target.value);
          target.value = value == null ? '' : String(value);
          const arr = groupScores[matchIdx] || [null, null];
          arr[side] = value;
          groupScores[matchIdx] = arr;
          const mode = document.getElementById('mode').value;
          if (mode === 'direct' || mode === 'playoff') renderAll(true);
          else renderTable();
        });
      });
      gamesRow.appendChild(gDiv);
    });
    block.appendChild(gamesRow);
    rundeList.appendChild(block);
  });
}

function renderTable() {
  const stats = createEmptyStats();
  resolvedMatches.forEach((m, idx) => {
    if (m.a == null || m.b == null) return;
    const score = groupScores[idx];
    if (!isCompleteScore(score)) return;
    applyMatchToStats(stats, m.a, m.b, score[0], score[1]);
  });
  const sorted = sortTeamsByStats(stats);
  const rows = sorted.map((teamId) => `
    <tr>
      <td class="team-badge" style="background:${colors[teamId]};color:${getContrastYIQ(colors[teamId])}">${teams[teamId]}</td>
      <td>${stats[teamId].win}</td>
      <td>${stats[teamId].draw}</td>
      <td>${stats[teamId].loss}</td>
      <td>${stats[teamId].pts}</td>
      <td>${stats[teamId].gf - stats[teamId].ga}</td>
    </tr>
  `).join('');
  document.querySelector('#tabelle tbody').innerHTML = rows;
}

function renderProgress() {
  const done = groupScores.filter((s) => isCompleteScore(s)).length;
  const total = resolvedMatches.length;
  const progress = document.getElementById('match-progress');
  if (!progress) return;
  progress.textContent = `Erfasst: ${done}/${total}`;
}

function renderTeamsEditor() {
  const teamsDiv = document.getElementById('teams');
  teamsDiv.innerHTML = '';
  for (let i = 0; i < TEAM_COUNT; i++) {
    const color = colors[i];
    const fg = getContrastYIQ(color);
    const tDiv = document.createElement('div');
    tDiv.className = 'team-edit-badge';
    tDiv.style.background = color;
    tDiv.style.color = fg;
    tDiv.innerHTML = `
      <input type="text" id="team${i}" value="${teams[i]}" maxlength="12" autocomplete="off" style="color:${fg}">
      <span class="colorpicker-icon" title="Farbe wählen">
        <svg viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="${color}" stroke="#bbb" stroke-width="2"/></svg>
      </span>
      <input type="color" id="color${i}" value="${color}" aria-label="Teamfarbe auswählen">
    `;
    teamsDiv.appendChild(tDiv);
    document.getElementById(`team${i}`).addEventListener('input', (e) => {
      teams[i] = e.target.value;
      renderAll(true);
    });
    tDiv.querySelector('.colorpicker-icon').onclick = (e) => {
      tDiv.querySelector('input[type="color"]').click();
      e.stopPropagation();
    };
    const colorInput = tDiv.querySelector('input[type="color"]');
    const onColorChange = (e) => {
      colors[i] = e.target.value;
      renderTeamsEditor();
      renderAll(true);
    };
    colorInput.addEventListener('input', onColorChange);
    colorInput.addEventListener('change', onColorChange);
  }
}

function renderAll(preserveScores = true) {
  const mode = document.getElementById('mode').value;
  const schedule = buildSchedule(mode);
  normalizeScoresLength(schedule.length, preserveScores);
  resolvedMatches = resolveSchedule(schedule);
  renderMatchEditor();
  renderRunden();
  renderTable();
  renderProgress();
}

document.getElementById('mode').addEventListener('change', () => renderAll(false));
document.getElementById('viewMode').addEventListener('change', (e) => {
  currentViewMode = e.target.value;
  localStorage.setItem(VIEW_STORAGE_KEY, currentViewMode);
  applyViewMode(currentViewMode);
});
window.addEventListener('resize', () => {
  if (currentViewMode === 'auto') applyViewMode('auto');
});
document.getElementById('resetBtn').addEventListener('click', () => {
  groupScores = groupScores.map(() => [null, null]);
  renderAll(true);
});

let timer = null;
let remaining = 300;
let beepPlayed = {};
function pad(num) { return num < 10 ? `0${num}` : String(num); }
function setCountdownDisplay(secs) {
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  document.getElementById('countdown').textContent = `${pad(m)}:${pad(s)}`;
}
function playShortBeep() {
  try {
    if (window.AudioContext) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 1000;
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.22, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.14);
      osc.start();
      osc.stop(ctx.currentTime + 0.14);
      osc.onended = () => ctx.close();
    }
  } catch (e) {}
}
function playBuzzer() {
  const audio = document.getElementById('buzzer');
  if (!audio) {
    playShortBeep();
    return Promise.resolve();
  }
  audio.currentTime = 0;
  return audio.play();
}
function playHorn() {
  const horn = document.getElementById('horn');
  if (!horn) return;
  horn.volume = 1;
  horn.currentTime = 0;
  horn.play();
}
function startTimer() {
  const min = Number(document.getElementById('min').value);
  const sec = Number(document.getElementById('sec').value);
  remaining = Math.max(0, (min * 60) + sec);
  setCountdownDisplay(remaining);
  if (timer) clearInterval(timer);
  beepPlayed = {};
  timer = setInterval(() => {
    if (remaining > 0) {
      remaining -= 1;
      setCountdownDisplay(remaining);
      if (remaining <= 5 && remaining > 0 && !beepPlayed[remaining]) {
        playShortBeep();
        beepPlayed[remaining] = true;
      }
      return;
    }
    setCountdownDisplay(0);
    playBuzzer().then(() => setTimeout(playHorn, 200));
    clearInterval(timer);
  }, 1000);
}

document.getElementById('startBtn').onclick = startTimer;
setCountdownDisplay(300);
loadViewMode();
renderTeamsEditor();
renderAll(false);
</script>
</body>
</html>
